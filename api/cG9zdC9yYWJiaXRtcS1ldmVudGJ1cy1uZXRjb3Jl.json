{"title":"RabbitMQ.EventBus.AspNetCore","date":"2019-05-06T05:52:00.000Z","slug":"rabbitmq-eventbus-netcore","categories":["知识储备"],"updated":"2019-05-06T08:49:49.835Z","content":"<p><a href=\"https://www.nuget.org/packages/RabbitMQ.EventBus.AspNetCore\" target=\"_blank\" rel=\"noopener\"><img src=\"https://img.shields.io/nuget/v/RabbitMQ.EventBus.AspNetCore.svg?style=popout\" alt=\"NuGet\"></a>  <a href=\"https://www.nuget.org/packages/RabbitMQ.EventBus.AspNetCore\" target=\"_blank\" rel=\"noopener\"><img src=\"https://img.shields.io/nuget/dt/RabbitMQ.EventBus.AspNetCore.svg?style=popout\" alt=\"NuGet\"></a></p>\n<p><code>RabbitMQ.EventBus.AspNetCore</code>是一个基于官方<code>RabbitMQ.Client</code>的二次封装包，专门针对<code>Net Core</code>项目进行开发，在<code>微服务</code>中进行消息的传递使用起来比较方便。</p>\n<h2 id=\"特性\">特性<a href=\"post/rabbitmq-eventbus-netcore#特性\"></a></h2><ol>\n<li>断线重连机制</li>\n<li>可扩展</li>\n<li>消费失败自动打回</li>\n</ol>\n<h3 id=\"使用说明\">使用说明<a href=\"post/rabbitmq-eventbus-netcore#使用说明\"></a></h3><h4 id=\"1-注册\">1. 注册<a href=\"post/rabbitmq-eventbus-netcore#1-注册\"></a></h4><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">string</span> assemblyName = <span class=\"keyword\">typeof</span>(Startup).GetTypeInfo().Assembly.GetName().Name;</span><br><span class=\"line\">    services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_1);</span><br><span class=\"line\">    services.AddRabbitMQEventBus(()=&gt;<span class=\"string\">\"amqp://guest:guest@192.168.0.252:5672/\"</span>, eventBusOptionAction: eventBusOption =&gt;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        eventBusOption.ClientProvidedAssembly(assemblyName);</span><br><span class=\"line\">        eventBusOption.EnableRetryOnFailure(<span class=\"literal\">true</span>, <span class=\"number\">5000</span>, TimeSpan.FromSeconds(<span class=\"number\">30</span>));</span><br><span class=\"line\">        eventBusOption.RetryOnFailure(TimeSpan.FromMilliseconds(<span class=\"number\">100</span>));</span><br><span class=\"line\">        eventBusOption.AddLogging(LogLevel.Warning);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    services.AddButterfly(butterfly =&gt;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        butterfly.CollectorUrl = <span class=\"string\">\"http://192.168.0.252:6401\"</span>;</span><br><span class=\"line\">        butterfly.Service = <span class=\"string\">\"RabbitMQEventBusTest\"</span>;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-订阅消息\">2. 订阅消息<a href=\"post/rabbitmq-eventbus-netcore#2-订阅消息\"></a></h4><h5 id=\"2-1-自动订阅消息\">2.1 自动订阅消息<a href=\"post/rabbitmq-eventbus-netcore#2-1-自动订阅消息\"></a></h5><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env, IServiceTracer tracer</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (env.IsDevelopment())</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    app.RabbitMQEventBusAutoSubscribe();</span><br><span class=\"line\">    app.UseMvc();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"2-2-手动订阅消息\">2.2 手动订阅消息<a href=\"post/rabbitmq-eventbus-netcore#2-2-手动订阅消息\"></a></h5><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IHostingEnvironment env, IRabbitMQEventBus eventBus</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (env.IsDevelopment())</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    eventBus.Serialize&lt;EventMessage, EventMessageHandler&gt;();</span><br><span class=\"line\">    app.UseMvc();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-发消息\">3. 发消息<a href=\"post/rabbitmq-eventbus-netcore#3-发消息\"></a></h4><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"meta-string\">\"api/[controller]\"</span>)</span>]</span><br><span class=\"line\">[<span class=\"meta\">ApiController</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">EventBusController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IRabbitMQEventBus _eventBus;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">EventBusController</span>(<span class=\"params\">IRabbitMQEventBus eventBus</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">        _eventBus = eventBus ?? <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ArgumentNullException(<span class=\"keyword\">nameof</span>(eventBus));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// GET api/values</span></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> IActionResult <span class=\"title\">Send</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">        _eventBus.Publish(<span class=\"keyword\">new</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Body = <span class=\"string\">\"发送消息\"</span>,</span><br><span class=\"line\">            Time = DateTimeOffset.Now</span><br><span class=\"line\">        &#125;, exchange: <span class=\"string\">\"RabbitMQ.EventBus.Simple\"</span>, routingKey: <span class=\"string\">\"rabbitmq.eventbus.test\"</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Ok();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"4-订阅消息\">4. 订阅消息<a href=\"post/rabbitmq-eventbus-netcore#4-订阅消息\"></a></h4><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">EventBus(Exchange = <span class=\"meta-string\">\"RabbitMQ.EventBus.Simple\"</span>, RoutingKey = <span class=\"meta-string\">\"rabbitmq.eventbus.test\"</span>)</span>]</span><br><span class=\"line\">[<span class=\"meta\">EventBus(Exchange = <span class=\"meta-string\">\"RabbitMQ.EventBus.Simple\"</span>, RoutingKey = <span class=\"meta-string\">\"rabbitmq.eventbus.test1\"</span>)</span>]</span><br><span class=\"line\">[<span class=\"meta\">EventBus(Exchange = <span class=\"meta-string\">\"RabbitMQ.EventBus.Simple\"</span>, RoutingKey = <span class=\"meta-string\">\"rabbitmq.eventbus.test2\"</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">MessageBody</span> : <span class=\"title\">IEvent</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">string</span> Body &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset Time &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">public class MessageBodyHandle : IEventHandler&lt;MessageBody&gt;, IDisposable</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;MessageBodyHandle&gt; _logger;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MessageBodyHandle</span>(<span class=\"params\">ILogger&lt;MessageBodyHandle&gt; logger</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">        _logger = logger ?? <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ArgumentNullException(<span class=\"keyword\">nameof</span>(logger));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">        Console.WriteLine(<span class=\"string\">\"释放\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">Handle</span>(<span class=\"params\">EventHandlerArgs&lt;MessageBody1&gt; args</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">        _logger.Information(args.Original);</span><br><span class=\"line\">        _logger.Information(args.Redelivered);</span><br><span class=\"line\">        _logger.Information(args.Exchange);</span><br><span class=\"line\">        _logger.Information(args.RoutingKey);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.Information(args.Event.Body);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Task.CompletedTask;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","next":{"title":"开发过程中需要用到的工具以及相关知识目录","slug":"develop-tools-and-faq"},"link":"http://ojdev.github.io/post/rabbitmq-eventbus-netcore/","toc":[{"title":"特性","id":"特性","index":"1","children":[{"title":"使用说明","id":"使用说明","index":"1.1","children":[{"title":"1. 注册","id":"1-注册","index":"1.1.1"},{"title":"2. 订阅消息","id":"2-订阅消息","index":"1.1.2"},{"title":"3. 发消息","id":"3-发消息","index":"1.1.3"},{"title":"4. 订阅消息","id":"4-订阅消息","index":"1.1.4"}]}]}]}