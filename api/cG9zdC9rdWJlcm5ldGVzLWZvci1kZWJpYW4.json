{"title":"k8s的环境搭建","date":"2019-06-03T09:31:00.000Z","slug":"kubernetes-for-debian","tags":["k8s,debian9"],"updated":"2019-06-05T03:36:11.573Z","content":"<p>依然是模拟环境，使用windows10的hyperV。</p>\n<p>在虚拟机中安装debian9，只要核心的那种，开openssh的。</p>\n<p>更新debian<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt update</span><br><span class=\"line\">apt upgrade -y</span><br></pre></td></tr></table></figure></p>\n<p>##开启root的ssh登录</p>\n<p>修改<code>/etc/ssh/sshd_config</code>中的 <code>PermitRootLogin</code>为<code>PermitRootLogin yes</code>，保存<br>然后重启<code>/etc/init.d/ssh restart</code><br>非必须</p>\n<p>##关闭交换内存</p>\n<blockquote>\n<p>kubernetes 的想法是将实例紧密包装到尽可能接近100％。 所有的部署应该与 CPU 和内存限制固定在一起。 所以如果调度程序发送一个 pod 到一台机器，它不应该使用交换，设计者不想交换，因为它会减慢速度，所以关闭 swap 主要是为了性能考虑。当然为了一些节省资源的场景，比如运行容器数量较多，可添加 kubelet 参数 –fail-swap-on=false 来解决。</p>\n</blockquote>\n<p>##然后安装<a href=\"https://opsx.alibaba.com/mirror?lang=zh-CN\" target=\"_blank\" rel=\"noopener\">k8s的aliyun源</a><br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class=\"line\">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - </span><br><span class=\"line\">cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class=\"line\">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class=\"line\">EOF  </span><br><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install -y kubelet kubeadm kubectl</span><br><span class=\"line\">apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure></p>\n<p>##添加docker源</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -</span><br><span class=\"line\"></span><br><span class=\"line\">cat &lt;&lt;EOF&gt;/etc/apt/sources.list.d/docker.list</span><br><span class=\"line\">deb [arch=amd64] https://download.docker.com/linux/debian stretch stable</span><br><span class=\"line\">EOF</span><br><span class=\"line\">apt update</span><br><span class=\"line\">apt install -y docker-ce</span><br></pre></td></tr></table></figure>\n<p>##添加docker的aliyun镜像源<a href=\"https://kubernetes.io/docs/setup/cri/\" target=\"_blank\" rel=\"noopener\">参考</a><br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF&gt;/etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  \"registry-mirrors\": [\"https://********.mirror.aliyuncs.com\"],</span><br><span class=\"line\">  \"exec-opts\": [\"native.cgroupdriver=systemd\"],</span><br><span class=\"line\">  \"log-driver\": \"json-file\",</span><br><span class=\"line\">  \"log-opts\": &#123;</span><br><span class=\"line\">    \"max-size\": \"100m\"</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  \"storage-driver\": \"overlay2\"</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart docker</span><br><span class=\"line\">systemctl enable docker</span><br></pre></td></tr></table></figure></p>\n<p>重启系统，让所有配置生效。</p>\n<p>##开始集群初始化<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure></p>\n<p><code>--image-repository</code>指定拉取镜像的地址，避免从google无法访问的情况<br>成功后的内容<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  mkdir -p $HOME/.kube</span><br><span class=\"line\">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class=\"line\">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm join 172.17.183.236:6443 --token 4xr9ys.yxaxewry4xarkghy \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:3a73933bfd0fb5e2fe2e045292a395d55c652e9e8a141111335b1710350f9d37</span><br></pre></td></tr></table></figure></p>\n<p>创建成功后根据提示进行操作，记录最先面的链接语句，以备其他节点接入。</p>\n","next":{"title":"在windows上创建kubernetes集群","slug":"kubernetes"},"link":"http://ojdev.github.io/post/kubernetes-for-debian/"}